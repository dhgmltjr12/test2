<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ (QR ìŠ¤ìº” ìµœì¢… ì•ˆì •í™”)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f7f7f7; }
        h2, h3 { color: #333; }
        input, button { 
            padding: 10px; 
            margin-top: 8px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }

        #scanner-area { 
            display: none; 
            margin-top: 20px; 
            text-align: center; 
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        video { 
            width: 100%; 
            max-width: 400px; 
            border: 3px solid #ccc; 
            border-radius: 8px;
            margin-top: 10px;
        }
        #output { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #ffe0b2; 
            background-color: #fff3e0; 
            color: #e65100; 
            border-radius: 4px;
            min-height: 50px;
        }
        #record-display {
            padding: 15px;
            background-color: #e8f5e9; 
            border: 1px solid #c8e6c9;
            border-radius: 8px;
        }
        #record-table th, #record-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        #record-table th {
            background-color: #dcedc8; 
        }
    </style>
</head>
<body>

    <h2>ğŸš— ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ (QR ìŠ¤ìº” ìµœì¢… ì•ˆì •í™”)</h2>
    <form id="info-form">
        <input type="text" id="car-number" placeholder="1. ì°¨ëŸ‰ë²ˆí˜¸ (ì˜ˆ: 12ê°€3456)" required>
        <input type="text" id="driver-name" placeholder="2. ì´ë¦„" required>
        <input type="tel" id="phone-number" placeholder="3. ì „í™”ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)" required>
        <input type="text" id="car-tonnage" placeholder="4. ì°¨ëŸ‰ í†¤ìˆ˜ (ì˜ˆ: 5í†¤ ë˜ëŠ” 5t)" required>
        
        <button type="submit">ì…ë ¥ ì™„ë£Œ & ì…ì°¨ QR ìŠ¤ìº” ì‹œì‘</button>
    </form>

    <div id="scanner-area">
        <h3>QR ìŠ¤ìº” ì¤‘...</h3>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="output">ìŠ¤ìº” ê²°ê³¼: ëŒ€ê¸° ì¤‘</div>
        
        <button id="checkout-start-btn" style="display: none; margin-top: 15px;">â–¶ í•˜ì°¨ ì§€ì  QR ìŠ¤ìº” ì‹œì‘</button>
    </div>

    <div id="record-display" style="margin-top: 30px; display: none;">
        <h3>âœ… ìµœì¢… ìš´í–‰ ê¸°ë¡</h3>
        <table id="record-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr><th>í•­ëª©</th><th>ë‚´ìš©</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsQR@1.0.0/dist/jsQR.min.js"></script>
    
    <script>
        const infoForm = document.getElementById('info-form');
        const scannerArea = document.getElementById('scanner-area');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const outputDiv = document.getElementById('output');
        const checkoutStartBtn = document.getElementById('checkout-start-btn');
        const recordDisplay = document.getElementById('record-display');
        const recordTableBody = document.querySelector('#record-table tbody');
        const ctx = canvas.getContext('2d');

        let stream = null;
        let isCheckingIn = true;

        infoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vehicleData = {
                carNum: document.getElementById('car-number').value,
                name: document.getElementById('driver-name').value,
                phoneNumber: document.getElementById('phone-number').value,
                carTonnage: document.getElementById('car-tonnage').value,
                checkinTime: null,
                checkinLocation: null,
                checkoutTime: null,
                checkoutLocation: null,
            };
            
            localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData));
            
            infoForm.style.display = 'none';
            scannerArea.style.display = 'block';
            recordDisplay.style.display = 'none';
            outputDiv.innerHTML = 'ğŸ“ <b>ì…ì°¨ ì§€ì  QR</b>ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
            checkoutStartBtn.style.display = 'none';
            
            isCheckingIn = true;
            startScanner();
        });

        checkoutStartBtn.addEventListener('click', function() {
            checkoutStartBtn.style.display = 'none';
            outputDiv.innerHTML = 'ğŸšš <b>í•˜ì°¨ ì§€ì  QR</b>ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
            recordDisplay.style.display = 'none';
            
            isCheckingIn = false;
            startScanner();
        });

        function startScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "environment",
                    width: { min: 640 },
                    height: { min: 480 }
                }
            })
            .then(function(s) {
                stream = s;
                video.srcObject = s;
                video.setAttribute('playsinline', true);
                video.play();

                setTimeout(() => {
                    requestAnimationFrame(tick);
                }, 300); // ë¹„ë””ì˜¤ ì´ˆê¸°í™” ì‹œê°„ í™•ë³´
            })
            .catch(function(err) {
                outputDiv.innerHTML = 'âš ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: HTTPS í™˜ê²½ê³¼ ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                console.error(err);
            });
        }

        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });

                if (code) {
                    handleScanResult(code.data);
                    return;
                } else {
                    outputDiv.innerHTML = isCheckingIn 
                        ? 'ğŸ“ ì…ì°¨ QR ìŠ¤ìº” ì¤‘... (í™”ë©´ ì¤‘ì•™ì— QRì„ ë§ì¶°ì£¼ì„¸ìš”)' 
                        : 'ğŸšš í•˜ì°¨ QR ìŠ¤ìº” ì¤‘... (í™”ë©´ ì¤‘ì•™ì— QRì„ ë§ì¶°ì£¼ì„¸ìš”)';
                }
            }

            if (stream) requestAnimationFrame(tick);
        }

        function handleScanResult(data) {
            stopScanner();
            
            let vehicleData = JSON.parse(localStorage.getItem('currentVehicleTrip'));

            if (isCheckingIn) {
                vehicleData.checkinTime = new Date().toLocaleTimeString('ko-KR');
                vehicleData.checkinLocation = data;
                
                outputDiv.innerHTML = `âœ… <b>ì…ì°¨ ì™„ë£Œ!</b> ì§€ì : <b>${data}</b><br> ì´ì œ í•˜ì°¨ ì§€ì ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.`;
                checkoutStartBtn.style.display = 'block';

            } else {
                vehicleData.checkoutTime = new Date().toLocaleTimeString('ko-KR');
                vehicleData.checkoutLocation = data;

                outputDiv.innerHTML = `âœ… <b>í•˜ì°¨ ì™„ë£Œ!</b> ì§€ì : <b>${data}</b><br> ìš´í–‰ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.`;
                displayFinalRecord(vehicleData);

                setTimeout(() => {
                    infoForm.reset();
                    infoForm.style.display = 'block';
                    scannerArea.style.display = 'none';
                    localStorage.removeItem('currentVehicleTrip');
                }, 5000);
            }

            localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData));
        }

        function displayFinalRecord(data) {
            recordTableBody.innerHTML = `
                <tr><td>ì°¨ëŸ‰ë²ˆí˜¸</td><td>${data.carNum}</td></tr>
                <tr><td>ì´ë¦„</td><td>${data.name}</td></tr>
                <tr><td>ì „í™”ë²ˆí˜¸</td><td>${data.phoneNumber}</td></tr>
                <tr><td>ì°¨ëŸ‰ í†¤ìˆ˜</td><td>${data.carTonnage}</td></tr>
                <tr><td>ì…ì°¨ ì‹œê°„/ì§€ì </td><td>${data.checkinTime} (${data.checkinLocation})</td></tr>
                <tr><td>í•˜ì°¨ ì‹œê°„/ì§€ì </td><td>${data.checkoutTime} (${data.checkoutLocation})</td></tr>
            `;
            recordDisplay.style.display = 'block';
        }

    </script>
</body>
</html>
