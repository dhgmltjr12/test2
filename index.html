<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>차량 출입 기록 시스템</title>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; }
input { width:100%; padding:10px; margin:8px 0; font-size:16px; }
button { width:100%; padding:14px; background:#007bff; color:white; border:none; font-size:18px; margin-top:10px; }
#reader { width:100%; margin-top:15px; }
#resultBox { margin-top:20px; padding:10px; background:#efefef; }
</style>
</head>

<body>
<h2>차량 출입 기록 시스템</h2>

<div id="inputForm">
<input id="carNum" placeholder="차량번호" />
<input id="name" placeholder="이름" />
<input id="phone" placeholder="연락처" />
<input id="ton" placeholder="차량 톤수" />
<button id="startBtn">입력완료 & QR 스캔 시작</button>
</div>

<div id="reader" style="display:none;"></div>
<div id="resultBox" style="display:none;"></div>
<button id="downloadBtn" style="display:none;" onclick="downloadExcel()">엑셀 다운로드</button>

<script>
let logData = [["차량번호","이름","연락처","톤수","시간","QR텍스트","GPS위도","GPS경도"]];

// -------------------- 후면 카메라 선택 --------------------
async function getRearCamera() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    let rear = devices.find(d => d.kind==="videoinput" && (d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("rear")));
    if(!rear){ 
        const vids = devices.filter(d=>d.kind==="videoinput");
        rear = vids[vids.length-1];
    }
    return rear ? rear.deviceId : null;
}

// -------------------- QR 스캔 시작 --------------------
async function startQRScan(car,name,phone,ton){
    document.getElementById("inputForm").style.display="none";
    document.getElementById("reader").style.display="block";

    const html5QrCode = new Html5Qrcode("reader");
    const rearId = await getRearCamera();
    const config = { fps:15, qrbox:{width:260,height:260}, rememberLastUsedCamera:true };

    Html5Qrcode.getCameras().then(cameras=>{
        html5QrCode.start(
            rearId || cameras[0].id,
            config,
            async (decodedText)=>{
                navigator.geolocation.getCurrentPosition(
                    (pos)=>{
                        const time = new Date().toLocaleString();
                        logData.push([car,name,phone,ton,time,decodedText,pos.coords.latitude,pos.coords.longitude]);
                        html5QrCode.stop();
                        showResult(decodedText,pos.coords.latitude,pos.coords.longitude,false);
                    },
                    (err)=>{
                        html5QrCode.stop();
                        alert("GPS 권한을 허용해야 위치 기록이 가능합니다.");
                        document.getElementById("inputForm").style.display="block";
                    },
                    {enableHighAccuracy:true,timeout:10000}
                );
            },
            (err)=>{}
        );
    });
}

// -------------------- 결과 표시 --------------------
function showResult(qrText,lat,lon,isFinal){
    const box = document.getElementById("resultBox");
    box.style.display="block";

    if(!isFinal){
        box.innerHTML = `
        <h3>충수지점 스캔 완료</h3>
        <p><b>QR 내용:</b> ${qrText}</p>
        <p><b>GPS 위도:</b> ${lat}</p>
        <p><b>GPS 경도:</b> ${lon}</p>
        <button onclick="startHacha()">하차지점 QR 스캔 시작</button>
        `;
    }else{
        box.innerHTML = `
        <h3>하차지점 스캔 완료</h3>
        <p><b>QR 내용:</b> ${qrText}</p>
        <p><b>GPS 위도:</b> ${lat}</p>
        <p><b>GPS 경도:</b> ${lon}</p>
        `;
    }

    document.getElementById("downloadBtn").style.display="block";
}

// -------------------- 하차지점 QR 스캔 --------------------
async function startHacha(){
    document.getElementById("resultBox").style.display="none";
    document.getElementById("reader").style.display="block";

    const html5QrCode = new Html5Qrcode("reader");
    const rearId = await getRearCamera();
    const config = { fps:15, qrbox:{width:260,height:260}, rememberLastUsedCamera:true };

    Html5Qrcode.getCameras().then(cameras=>{
        html5QrCode.start(
            rearId || cameras[0].id,
            config,
            (decodedText)=>{
                navigator.geolocation.getCurrentPosition(
                    (pos)=>{
                        const time = new Date().toLocaleString();
                        logData.push(["-","-","-","-",time,decodedText,pos.coords.latitude,pos.coords.longitude]);
                        html5QrCode.stop();
                        showResult(decodedText,pos.coords.latitude,pos.coords.longitude,true);
                    },
                    (err)=>{
                        html5QrCode.stop();
                        alert("GPS 권한을 허용해야 위치 기록이 가능합니다.");
                    },
                    {enableHighAccuracy:true,timeout:10000}
                );
            }
        );
    });
}

// -------------------- 엑셀 다운로드 --------------------
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(logData);
    XLSX.utils.book_append_sheet(wb,ws,"출입기록");
    XLSX.writeFile(wb,"vehicle_log.xlsx");
}

// -------------------- 버튼 클릭 이벤트 --------------------
document.getElementById("startBtn").addEventListener("click",()=>{
    const car = document.getElementById("carNum").value.trim();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const ton = document.getElementById("ton").value.trim();

    if(!car||!name||!phone||!ton){ alert("모든 입력값을 입력하세요."); return; }

    // 클릭 이벤트 안에서 GPS 권한 요청
    navigator.geolocation.getCurrentPosition(
        (pos)=>{ startQRScan(car,name,phone,ton); },
        (err)=>{ alert("GPS 권한을 허용해야 스캔을 시작할 수 있습니다."); },
        {enableHighAccuracy:true,timeout:10000}
    );
});
</script>
</body>
</html>
