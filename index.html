<script>
const infoForm = document.getElementById('info-form');
const scannerArea = document.getElementById('scanner-area');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const outputDiv = document.getElementById('output');
const checkoutStartBtn = document.getElementById('checkout-start-btn');
const recordDisplay = document.getElementById('record-display');
const recordTableBody = document.querySelector('#record-table tbody');
const ctx = canvas.getContext('2d');

let stream = null;
let isCheckingIn = true;

infoForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const vehicleData = {
        carNum: document.getElementById('car-number').value,
        name: document.getElementById('driver-name').value,
        phoneNumber: document.getElementById('phone-number').value,
        carTonnage: document.getElementById('car-tonnage').value,
        checkinTime: null,
        checkinLocation: null,
        checkoutTime: null,
        checkoutLocation: null,
    };
    
    localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData));
    
    infoForm.style.display = 'none';
    scannerArea.style.display = 'block';
    recordDisplay.style.display = 'none';
    outputDiv.innerHTML = 'ğŸ“ <b>ì…ì°¨ ì§€ì  QR</b>ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
    checkoutStartBtn.style.display = 'none';
    
    isCheckingIn = true;
    startScanner();
});

checkoutStartBtn.addEventListener('click', function() {
    checkoutStartBtn.style.display = 'none';
    outputDiv.innerHTML = 'ğŸšš <b>í•˜ì°¨ ì§€ì  QR</b>ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
    recordDisplay.style.display = 'none';
    
    isCheckingIn = false;
    startScanner();
});

function startScanner() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }

    navigator.mediaDevices.getUserMedia({
        video: { 
            facingMode: "environment",
            width: { min: 640 },
            height: { min: 480 }
        }
    })
    .then(function(s) {
        stream = s;
        video.srcObject = s;
        video.setAttribute('playsinline', true);
        video.play();
        requestAnimationFrame(tick);
    })
    .catch(function(err) {
        outputDiv.innerHTML = 'âš ï¸ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: HTTPS í™˜ê²½ê³¼ ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        console.error(err);
    });
}

function stopScanner() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

// QR ìŠ¤ìº” ë£¨í”„
function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"  // ëª¨ë“  QR ì½”ë“œ ì¸ì‹
        });

        if (code && code.data) {
            // QR ì½”ë“œê°€ ê°ì§€ë˜ë©´ ì¦‰ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ
            handleScanResult(code.data);
            return;
        } else {
            outputDiv.innerHTML = isCheckingIn 
                ? 'ğŸ“ ì…ì°¨ QR ìŠ¤ìº” ì¤‘... (í™”ë©´ ì¤‘ì•™ì— QRì„ ë§ì¶°ì£¼ì„¸ìš”)' 
                : 'ğŸšš í•˜ì°¨ QR ìŠ¤ìº” ì¤‘... (í™”ë©´ ì¤‘ì•™ì— QRì„ ë§ì¶°ì£¼ì„¸ìš”)';
        }
    }

    if (stream) requestAnimationFrame(tick);
}

function handleScanResult(data) {
    stopScanner();
    
    let vehicleData = JSON.parse(localStorage.getItem('currentVehicleTrip'));

    if (isCheckingIn) {
        vehicleData.checkinTime = new Date().toLocaleTimeString('ko-KR');
        vehicleData.checkinLocation = data;
        
        outputDiv.innerHTML = `âœ… <b>ì…ì°¨ ì™„ë£Œ!</b> ì§€ì : <b>${data}</b><br> ì´ì œ í•˜ì°¨ ì§€ì ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.`;
        checkoutStartBtn.style.display = 'block';

    } else {
        vehicleData.checkoutTime = new Date().toLocaleTimeString('ko-KR');
        vehicleData.checkoutLocation = data;

        outputDiv.innerHTML = `âœ… <b>í•˜ì°¨ ì™„ë£Œ!</b> ì§€ì : <b>${data}</b><br> ìš´í–‰ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.`;
        displayFinalRecord(vehicleData);

        setTimeout(() => {
            infoForm.reset();
            infoForm.style.display = 'block';
            scannerArea.style.display = 'none';
            localStorage.removeItem('currentVehicleTrip');
        }, 5000);
    }

    localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData));
}

function displayFinalRecord(data) {
    recordTableBody.innerHTML = `
        <tr><td>ì°¨ëŸ‰ë²ˆí˜¸</td><td>${data.carNum}</td></tr>
        <tr><td>ì´ë¦„</td><td>${data.name}</td></tr>
        <tr><td>ì „í™”ë²ˆí˜¸</td><td>${data.phoneNumber}</td></tr>
        <tr><td>ì°¨ëŸ‰ í†¤ìˆ˜</td><td>${data.carTonnage}</td></tr>
        <tr><td>ì…ì°¨ ì‹œê°„/ì§€ì </td><td>${data.checkinTime} (${data.checkinLocation})</td></tr>
        <tr><td>í•˜ì°¨ ì‹œê°„/ì§€ì </td><td>${data.checkoutTime} (${data.checkoutLocation})</td></tr>
    `;
    recordDisplay.style.display = 'block';
}
</script>
