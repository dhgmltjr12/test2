<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ (QR ì¸ì‹ë¥  ìµœëŒ€ ë¶€ìŠ¤íŒ…)</title>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼ */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f7f7f7; }
        h2, h3 { color: #333; }
        input, button { 
            padding: 10px; 
            margin-top: 8px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }

        #scanner-area { 
            display: none; 
            margin-top: 20px; 
            text-align: center; 
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
        }
        video, #canvas-overlay { 
            width: 100%; 
            border: 3px solid #ccc; 
            border-radius: 8px;
            display: block;
        }
        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
        }
        #output { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #ffe0b2; 
            background-color: #fff3e0; 
            color: #e65100; 
            border-radius: 4px;
            min-height: 50px;
        }
        #record-display {
            padding: 15px;
            background-color: #e8f5e9; 
            border: 1px solid #c8e6c9;
            border-radius: 8px;
        }
        #record-table th, #record-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        #record-table th {
            background-color: #dcedc8; 
        }
    </style>
</head>
<body>

    <h2>ğŸš— ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ (QR ì¸ì‹ë¥  ìµœëŒ€ ë¶€ìŠ¤íŒ…)</h2>
    <form id="info-form">
        <input type="text" id="car-number" placeholder="1. ì°¨ëŸ‰ë²ˆí˜¸ (ì˜ˆ: 12ê°€3456)" required>
        <input type="text" id="driver-name" placeholder="2. ì´ë¦„" required>
        <input type="tel" id="phone-number" placeholder="3. ì „í™”ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)" required>
        <input type="text" id="car-tonnage" placeholder="4. ì°¨ëŸ‰ í†¤ìˆ˜ (ì˜ˆ: 5í†¤ ë˜ëŠ” 5t)" required>
        
        <button type="submit">ì…ë ¥ ì™„ë£Œ & ì…ì°¨ QR ìŠ¤ìº” ì‹œì‘</button>
    </form>

    <div id="scanner-area">
        <h3>QR ìŠ¤ìº” ì¤‘...</h3>
        <div id="video-container">
            <video id="video" autoplay playsinline style="transform: scaleX(-1);"></video>
            <canvas id="canvas-overlay"></canvas> 
        </div>
        <canvas id="canvas" style="display: none;"></canvas>
        <div id="output">ìŠ¤ìº” ê²°ê³¼: ëŒ€ê¸° ì¤‘</div>
        
        <button id="checkout-start-btn" style="display: none; margin-top: 15px;">â–¶ í•˜ì°¨ ì§€ì  QR ìŠ¤ìº” ì‹œì‘</button>
    </div>

    <div id="record-display" style="margin-top: 30px; display: none;">
        <h3>âœ… ìµœì¢… ìš´í–‰ ê¸°ë¡</h3>
        <table id="record-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr><th>í•­ëª©</th><th>ë‚´ìš©</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsQR@1.0.0/dist/jsQR.min.js"></script>
    
    <script>
        const infoForm = document.getElementById('info-form');
        const scannerArea = document.getElementById('scanner-area');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const canvasOverlay = document.getElementById('canvas-overlay');
        const outputDiv = document.getElementById('output');
        const checkoutStartBtn = document.getElementById('checkout-start-btn');
        const recordDisplay = document.getElementById('record-display');
        const recordTableBody = document.querySelector('#record-table tbody');
        
        const ctx = canvas.getContext('2d'); 
        const ctxOverlay = canvasOverlay.getContext('2d');

        let stream = null;
        let isCheckingIn = true; 
        let scanLoopId = null;

        infoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const vehicleData = {
                carNum: document.getElementById('car-number').value,
                name: document.getElementById('driver-name').value,
                phoneNumber: document.getElementById('phone-number').value,
                carTonnage: document.getElementById('car-tonnage').value,
                checkinTime: null, checkinLocation: null,
                checkoutTime: null, checkoutLocation: null,
            };
            localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData));
            infoForm.style.display = 'none';
            scannerArea.style.display = 'block';
            outputDiv.innerHTML = 'ğŸ“ **ì…ì°¨ ì§€ì  QR**ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
            isCheckingIn = true;
            startScanner();
        });

        checkoutStartBtn.addEventListener('click', function() {
            checkoutStartBtn.style.display = 'none';
            outputDiv.innerHTML = 'ğŸšš **í•˜ì°¨ ì§€ì  QR**ì„ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.';
            isCheckingIn = false;
            startScanner();
        });

        // â­ 1. ëª¨ë“  Constrainì„ ê°•ì œë¡œ ìš”ì²­í•˜ì—¬ ì´ˆì  ë° ëŒ€ë¹„ ì•ˆì •í™”
        function startScanner() {
            if (stream) { stopScanner(); }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    // â­ ì•ˆì • í•´ìƒë„ ê³ ì •
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    // â­ ê³ ê¸‰ Constrain ìš”ì²­ (ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ëŠ” ê²½ìš° í¬ì»¤ìŠ¤/ì¤Œ/ëŒ€ë¹„ ê°œì„ )
                    advanced: [{
                        torch: true, // í”Œë˜ì‹œ ìš”ì²­ (ì–´ë‘ìš´ í™˜ê²½ ëŒ€ë¹„)
                        focusMode: 'manual', // ìˆ˜ë™ ì´ˆì  ëª¨ë“œ ìš”ì²­ (ë¸Œë¼ìš°ì € ì¬ëŸ‰)
                        zoom: { min: 1, max: 2, step: 0.1 } // ì¤Œ ê¸°ëŠ¥ ìš”ì²­
                    }]
                } 
            })
                .then(function(s) {
                    stream = s;
                    video.srcObject = s;
                    video.setAttribute('playsinline', true);
                    video.play();
                    
                    video.addEventListener('loadeddata', function() {
                         canvasOverlay.width = video.videoWidth;
                         canvasOverlay.height = video.videoHeight;
                         if (!scanLoopId) {
                            scanLoopId = setTimeout(tick, 100);
                         }
                    }, { once: true });
                })
                .catch(function(err) {
                    console.error('CRITICAL CAMERA ACCESS ERROR:', err);
                    outputDiv.innerHTML = 'âŒ **ì¹´ë©”ë¼ ì˜¤ë¥˜!** (HTTPS ë° ê¶Œí•œ í™•ì¸)';
                });
        }

        function stopScanner() {
            if (scanLoopId) { clearTimeout(scanLoopId); scanLoopId = null; }
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        }

        // â­ 2. ì´ë¯¸ì§€ ì „ì²˜ë¦¬ë¥¼ í¬í•¨í•œ QR ìŠ¤ìº” ë£¨í”„ (tick í•¨ìˆ˜)
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const analysisWidth = video.videoWidth;
                const analysisHeight = video.videoHeight;
                canvas.width = analysisWidth;
                canvas.height = analysisHeight;
                
                ctx.drawImage(video, 0, 0, analysisWidth, analysisHeight);
                let imageData = ctx.getImageData(0, 0, analysisWidth, analysisHeight);
                
                // â­ 3. ì´ë¯¸ì§€ ì „ì²˜ë¦¬: ëŒ€ë¹„ ê°œì„  (Thresholding) ì‹œë„
                // ëŒ€ë¹„ê°€ ë‚®ì€ QR ì½”ë“œì˜ ì¸ì‹ì„ ë•ê¸° ìœ„í•´ í”½ì…€ ê°’ì„ ì¡°ì •í•©ë‹ˆë‹¤.
                imageData = applyContrastBoost(imageData); 
                
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert", // ë°˜ì „ ì´ë¯¸ì§€ ì‹œë„ëŠ” ì„±ëŠ¥ ì €í•˜ ìš°ë ¤ë¡œ ìœ ì§€
                });
                
                ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);

                if (code) {
                    drawBoundingBox(code.location, ctxOverlay);
                    console.log('âœ… QR Code Found:', code.data); 
                    handleScanResult(code.data);
                    return; 
                } else {
                    outputDiv.innerHTML = isCheckingIn 
                        ? 'ğŸ“ **ì…ì°¨ QR ìŠ¤ìº” ì¤‘...** (í™”ë©´ ì¤‘ì•™ì— ì´ˆì ì„ ë§ì¶°ì£¼ì„¸ìš”)' 
                        : 'ğŸšš **í•˜ì°¨ QR ìŠ¤ìº” ì¤‘...** (í™”ë©´ ì¤‘ì•™ì— ì´ˆì ì„ ë§ì¶°ì£¼ì„¸ìš”)';
                }
            }
            scanLoopId = setTimeout(tick, 100); 
        }
        
        // â­ 4. ëŒ€ë¹„ ê°œì„  (Thresholding) í•¨ìˆ˜
        function applyContrastBoost(imageData) {
            const data = imageData.data;
            let sum = 0;

            // 1ë‹¨ê³„: í‰ê·  ë°ê¸° (threshold) ê³„ì‚°
            for (let i = 0; i < data.length; i += 4) {
                // R, G, B í‰ê· ìœ¼ë¡œ ë°ê¸° ê³„ì‚°
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                sum += brightness;
            }
            const threshold = sum / (data.length / 4);

            // 2ë‹¨ê³„: ì´ì§„í™” ì ìš© (ëŒ€ë¹„ ê·¹ëŒ€í™”)
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                let value = brightness > threshold ? 255 : 0;
                
                data[i] = value;     // R
                data[i + 1] = value; // G
                data[i + 2] = value; // B
                // AëŠ” ìœ ì§€
            }
            return imageData;
        }

        // ê²½ê³„ì„  ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ë™ì¼)
        function drawBoundingBox(location, ctx) {
            ctx.strokeStyle = "#FF3B3B";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            ctx.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            ctx.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            ctx.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            ctx.lineTo(location.topLeftCorner.x, location.topLeftCorner.y);
            ctx.stroke();
        }

        // 5, 6ë²ˆ í•¨ìˆ˜ (handleScanResult, displayFinalRecord)ëŠ” ì´ì „ê³¼ ë™ì¼
        function handleScanResult(data) { /* ... ë¡œì§ ìœ ì§€ ... */
            stopScanner(); 
            let vehicleData = JSON.parse(localStorage.getItem('currentVehicleTrip'));
            if (isCheckingIn) {
                vehicleData.checkinTime = new Date().toLocaleTimeString('ko-KR');
                vehicleData.checkinLocation = data;
                outputDiv.innerHTML = `âœ… **ì…ì°¨ ì™„ë£Œ!** ì§€ì : **${data}**<br> ì´ì œ í•˜ì°¨ ì§€ì ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.`;
                checkoutStartBtn.style.display = 'block';
            } else {
                vehicleData.checkoutTime = new Date().toLocaleTimeString('ko-KR');
                vehicleData.checkoutLocation = data;
                outputDiv.innerHTML = `âœ… **í•˜ì°¨ ì™„ë£Œ!** ì§€ì : **${data}**<br> ìš´í–‰ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.`;
                displayFinalRecord(vehicleData); 
                setTimeout(() => {
                    infoForm.reset(); infoForm.style.display = 'block';
                    scannerArea.style.display = 'none'; localStorage.removeItem('currentVehicleTrip'); 
                }, 5000); 
            }
            localStorage.setItem('currentVehicleTrip', JSON.stringify(vehicleData)); 
        }

        function displayFinalRecord(data) { /* ... ë¡œì§ ìœ ì§€ ... */
            recordTableBody.innerHTML = `
                <tr><td>ì°¨ëŸ‰ë²ˆí˜¸</td><td>${data.carNum}</td></tr>
                <tr><td>ì´ë¦„</td><td>${data.name}</td></tr>
                <tr><td>ì „í™”ë²ˆí˜¸</td><td>${data.phoneNumber}</td></tr>
                <tr><td>ì°¨ëŸ‰ í†¤ìˆ˜</td><td>${data.carTonnage}</td></tr>
                <tr><td>**ì…ì°¨ ì‹œê°„/ì§€ì **</td><td>${data.checkinTime} (${data.checkinLocation})</td></tr>
                <tr><td>**í•˜ì°¨ ì‹œê°„/ì§€ì **</td><td>${data.checkoutTime} (${data.checkoutLocation})</td></tr>
            `;
            recordDisplay.style.display = 'block';
        }
    </script>
</body>
</html>