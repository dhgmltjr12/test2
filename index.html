<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ</title>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; }
input { width:100%; padding:10px; margin:8px 0; font-size:16px; }
button { width:100%; padding:14px; background:#007bff; color:white; border:none; font-size:18px; margin-top:10px; }
#reader { width:100%; margin-top:15px; }
#resultBox { margin-top:20px; padding:10px; background:#efefef; }
</style>
</head>

<body>
<h2>ì°¨ëŸ‰ ì¶œì… ê¸°ë¡ ì‹œìŠ¤í…œ</h2>

<div id="inputForm">
<input id="carNum" placeholder="ì°¨ëŸ‰ë²ˆí˜¸" />
<input id="name" placeholder="ì´ë¦„" />
<input id="phone" placeholder="ì—°ë½ì²˜" />
<input id="ton" placeholder="ì°¨ëŸ‰ í†¤ìˆ˜" />
<button id="startBtn">ì…ë ¥ì™„ë£Œ & QR ìŠ¤ìº” ì‹œì‘</button>
</div>

<div id="reader" style="display:none;"></div>
<div id="resultBox" style="display:none;"></div>
<button id="downloadBtn" style="display:none;" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

<script>
let logData = [["ì°¨ëŸ‰ë²ˆí˜¸","ì´ë¦„","ì—°ë½ì²˜","í†¤ìˆ˜","ì‹œê°„","QRí…ìŠ¤íŠ¸","GPSìœ„ë„","GPSê²½ë„"]];

// -------------------- ì‹œê°„ í¬ë§· --------------------
function getFormattedTime(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const min = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
}

// -------------------- í›„ë©´ ì¹´ë©”ë¼ ì„ íƒ --------------------
async function getRearCamera() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    let rear = devices.find(d => d.kind==="videoinput" && (d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("rear")));
    if(!rear){ 
        const vids = devices.filter(d=>d.kind==="videoinput");
        rear = vids[vids.length-1];
    }
    return rear ? rear.deviceId : null;
}

// -------------------- QR ê¸°ë¡ --------------------
function recordQR(car,name,phone,ton,decodedText,isHacha=false){
    navigator.geolocation.getCurrentPosition(
        (pos)=>{
            const time = getFormattedTime();
            if(!isHacha){
                logData.push([car,name,phone,ton,time,decodedText,pos.coords.latitude,pos.coords.longitude]);
                showResult(decodedText,pos.coords.latitude,pos.coords.longitude,false);
            } else {
                logData.push(["-","-","-","-",time,decodedText,pos.coords.latitude,pos.coords.longitude]);
                showResult(decodedText,pos.coords.latitude,pos.coords.longitude,true);
            }
        },
        (err)=>{
            alert("GPS ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ìœ„ì¹˜ ê¸°ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        },
        {enableHighAccuracy:true,timeout:10000}
    );
}

// -------------------- QR ìŠ¤ìº” ì‹œì‘ --------------------
async function startQRScan(car,name,phone,ton){
    document.getElementById("inputForm").style.display="none";
    document.getElementById("reader").style.display="block";

    const html5QrCode = new Html5Qrcode("reader");
    const rearId = await getRearCamera();
    const config = { fps:15, qrbox:{width:260,height:260}, rememberLastUsedCamera:true };

    Html5Qrcode.getCameras().then(cameras=>{
        html5QrCode.start(
            rearId || cameras[0].id,
            config,
            (decodedText)=>{
                html5QrCode.stop().then(()=>{
                    recordQR(car,name,phone,ton,decodedText,false);
                });
            },
            (err)=>{}
        );
    });
}

// -------------------- í•˜ì°¨ì§€ì  ìŠ¤ìº” --------------------
async function startHacha(){
    document.getElementById("resultBox").style.display="none";
    document.getElementById("reader").style.display="block";

    const html5QrCode = new Html5Qrcode("reader");
    const rearId = await getRearCamera();
    const config = { fps:15, qrbox:{width:260,height:260}, rememberLastUsedCamera:true };

    Html5Qrcode.getCameras().then(cameras=>{
        html5QrCode.start(
            rearId || cameras[0].id,
            config,
            (decodedText)=>{
                html5QrCode.stop().then(()=>{
                    recordQR(null,null,null,null,decodedText,true);
                });
            }
        );
    });
}

// -------------------- ê²°ê³¼ í‘œì‹œ --------------------
function showResult(qrText,lat,lon,isFinal){
    const box = document.getElementById("resultBox");
    box.style.display="block";

    if(!isFinal){
        box.innerHTML = `
        <h3>ì¶©ìˆ˜ì§€ì  ìŠ¤ìº” ì™„ë£Œ</h3>
        <p><b>QR ë‚´ìš©:</b> ${qrText}</p>
        <p><b>GPS ìœ„ë„:</b> ${lat}</p>
        <p><b>GPS ê²½ë„:</b> ${lon}</p>
        <button onclick="startHacha()">í•˜ì°¨ì§€ì  QR ìŠ¤ìº” ì‹œì‘</button>
        `;
    } else {
        box.innerHTML = `
        <h3>í•˜ì°¨ì§€ì  ìŠ¤ìº” ì™„ë£Œ</h3>
        <p><b>QR ë‚´ìš©:</b> ${qrText}</p>
        <p><b>GPS ìœ„ë„:</b> ${lat}</p>
        <p><b>GPS ê²½ë„:</b> ${lon}</p>
        `;
    }

    document.getElementById("downloadBtn").style.display="block";
}

// -------------------- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ --------------------
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(logData);
    XLSX.utils.book_append_sheet(wb,ws,"ì¶œì…ê¸°ë¡");
    XLSX.writeFile(wb,"vehicle_log.xlsx");
}

// -------------------- ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ --------------------
document.getElementById("startBtn").addEventListener("click",()=>{
    const car = document.getElementById("carNum").value.trim();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const ton = document.getElementById("ton").value.trim();

    if(!car||!name||!phone||!ton){ alert("ëª¨ë“  ì…ë ¥ê°’ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

    // ğŸ”¹ ê¶Œí•œ ì²´í¬
    if (navigator.permissions){
        navigator.permissions.query({name:'geolocation'}).then(function(result){
            if(result.state === 'granted'){
                startQRScan(car,name,phone,ton);
            } else if(result.state === 'prompt'){
                navigator.geolocation.getCurrentPosition(
                    (pos)=>{ startQRScan(car,name,phone,ton); },
                    (err)=>{ alert("GPS ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ìŠ¤ìº”ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); },
                    {enableHighAccuracy:true,timeout:10000}
                );
            } else {
                alert("GPS ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }
        });
    } else {
        // êµ¬í˜• ë¸Œë¼ìš°ì € fallback
        navigator.geolocation.getCurrentPosition(
            (pos)=>{ startQRScan(car,name,phone,ton); },
            (err)=>{ alert("GPS ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ìŠ¤ìº”ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); },
            {enableHighAccuracy:true,timeout:10000}
        );
    }
});
</script>
</body>
</html>
